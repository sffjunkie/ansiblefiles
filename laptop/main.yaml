---
- hosts: laptop
  become: true
  vars:
    ansible_port: "{{ ssh_port }}"
  vars_files:
    - ../vars/secrets.yaml
    - ../vars/development.yaml
    - ../vars/main.yaml

  pre_tasks:
    - name: Debug
      ansible.builtin.debug:
        msg:
          - "Computed stats"
          - "  Configuration file home directory: {{ config_home }}"
          - "  Shell: {{ shell }}"
          - "  Distribution: {{ distribution }}"
          - "  OS Family: {{ os_family }}"
          - "  Development Environments: {{ development_roles | join(', ') }}"

    - name: Create .local directories
      file:
        path: "{{ item }}"
        state: directory
        mode: 0755
        owner: "{{ userid }}"
        group: "{{ userid }}"
      loop:
        - ~/.local
        - ~/.local/bin

  roles:
    # - role: PeterMosmans.virtualbox-guest # FIXME: Needs fixing
    - role: os_packages_ansible
    - role: os_packages
      package_list: "{{ packages.os }}"
    - role: pypi_packages
      package_list: "{{ packages.pypi }}"

    # Install git with values from secrets.yaml
    - role: git
      name: "{{ git.name }}"
      email: "{{ git.email }}"
      gpg_key: "{{ git.gpg_key }}"

    # - python3-gobject
    # - x11
    # - development
    # - docker
    # - exa
    # - role: font
    #   font_url: "{{ font }}"

#     - ansible.builtin.include_role:
#         name: xdg_user_dirs
#         vars:
#           custom_xdg_user_dirs:
#             XDG_PUBLICSHARE_DIR:

  tasks:
#     - name: Install zsh.
#       ansible.builtin.include_role:
#         name: zsh
#       when: shell == 'zsh'

#     # This task needs to run near the end so that previous roles/tasks
#     # can add to the list of oh-my-zsh plugins
#     # See ./vars/main.yaml
#     - name: Install oh-my-zsh.
#       ansible.builtin.include_role:
#         name: ohmyzsh
#       when: shell == 'zsh' and ohmyzsh is defined

    - name: Configfiles configuration
      ansible.builtin.debug:
        msg: "{{ configfiles }}"

# - name: Run configfiles playbook
#   ansible.builtin.import_playbook: ../configfiles/main.yaml
#   tags:
#     - configfiles

# - name: Run scriptfiles playbook
#   ansible.builtin.import_playbook: ../scriptfiles/main.yaml
#   tags:
#     - scriptfiles

# - name: Copy config files
#   ansible.builtin.copy:
#     src: "{{ configfiles_path }}/*"
#     dest: "/home/{{ user.id }}/"
